# presto 설정

$ /usr/lib/presto/bin/presto-cli-0.227-executable --server localhost:8889 --catalog hive --schema class

presto:default> show tables ;
presto:default> select * from hive.njkwon.danji_user_view;

# SQL 샘플
# 시나리오 : 서울 아파트단지중에서 2024년도 1월 26일 가장 많이 조회한 단지?
select *
from story_data.danji_user_view_summary
order by view_count desc

select *
from story_data.danji_user_view_silver a 
join "storydb"."fc-danji_json" b 
on cast(a.apart_id as integer) = b.id
limit 12;

# 해당 단지를 가장많이 조회한사람
select adid, count(*) 
from story_data.danji_user_view_silver
where apart_id='701'
group by adid
order by count(*) desc
;

# 해당 사용자가 조회한 다른 단지 및 메뉴는
select *
from applog
where adid = '7ad34486-a001-44df-96cf-8412942277ae' 



#사용자에 의해 패치된 presto-jdbc 사용

https://github.com/gabrielrcouto/presto/releases

cd /home/hadoop

sudo wget https://github.com/gabrielrcouto/presto/releases/download/0.225/presto-jdbc-0.225-SNAPSHOT.jar 

sudo chown hadoop:hadoop presto-jdbc-0.225-SNAPSHOT.jar 


#
default.driver : com.facebook.presto.jdbc.PrestoDriver
default.url    : jdbc:presto://localhost:8889
default.user   : hive


Driver download 설명서
https://www.tableau.com/ko-kr/support/drivers?edition=pro&lang=ko-kr&platform=mac&cpu=64&version=2019.2&__full-version=20192.20.0119.2115#athena


Download site 
https://docs.aws.amazon.com/athena/latest/ug/connect-with-jdbc.html

Mac : 
$cd ~/Library/Tableau/Drivers
$cp ~/Downloads/AthenaJDBC42.jar .

Window : 
C:\Program Files\Tableau\Drivers




#

$ sudo yum install -y java-1.8.0-openjdk-devel.x86_64
5.2. logstash - producer 프로그램설치  from twitter p53 


$ sudo yum install java-11-amazon-corretto-headless
$ sudo yum install java-11-amazon-corretto
$ wget https://artifacts.elastic.co/downloads/logstash/logstash-7.4.0.tar.gz
$ tar xvzf logstash-7.4.0.tar.gz
$ ln -s logstash-7.4.0 logstash

- 초기화 파일에 추가해준다. : 어느 폴더에서도 logstash 실행가능 
$ vi ~/.bash_profile

export LS_HOME=/home/ec2-user/logstash
PATH=$PATH:$LS_HOME/bin

$ source ~/.bash_profile

$ logstash --version


$ wget https://artifacts.elastic.co/downloads/logstash/logstash-7.4.0.tar.gz
$ tar xvzf logstash-7.4.0.tar.gz
$ ln -s logstash-7.1.0 logstash

$ vi ~/.bash_profile

export LS_HOME=/home/ec2-user/logstash
PATH=$PATH:$LS_HOME/bin

$ source ~/.bash_profile

$ logstash --version

$ mkdir producer
$ cd producer
$ vi producer_test.conf

input {
  s3 {
      bucket => "fc-class"
      codec => "json"
      prefix => "temp/json/"
      region => "ap-southeast-2"
      interval => "10"
      watch_for_new_files => false
    }
  }
output {
stdout {codec=>rubydebug}
}

$mkdir json 
s3://fc-class/temp/json/
$cp producer_test.conf producer.conf

input {
s3 {
access_key_id => "AKIAZ2PFIxxx54RNGZW"
secret_access_key => "Znfz9nxxxZyxxxUz5kImGn5GxF7Zhuk62"
bucket => "fc-class"
region => "ap-northeast-2"
prefix => "temp/json"

sincedb_path => "/dev/null"
}

}
filter {
  json {
    source => "message"
  }
  mutate { 
    remove_field => ["@version","host","message"] 
    }
}
output {
  elasticsearch {
    hosts => ["https://sexxx-yhf2jbooskxxxwuuhvg5u.ap-northeast-2.es.amazonaws.com:443"]
    ssl => true
    index => "class-%{+YYYY.MM.dd}"
    user => "class"
    password => "Votmxmzoavjtm1@"
    ilm_enabled => false
  }
}


https://www.tableau.com/products/trial 

각자 os 맞는 tableau 를 설치한다.

odbc 설치
https://www.tableau.com/ko-kr/support/drivers

presto 와 mysql driver 설치 

